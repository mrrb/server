version: '3.3'

services:
  shlink:
    image: shlinkio/shlink:${SHLINK_IMAGE_VERSION:-stable}
    restart: always
    container_name: shlink-backend
    networks:
      - 'srv'
      - 'shlink-internal'
    restart: always
    depends_on:
      - shlink-db
    environment:
      # General
      DEFAULT_DOMAIN: ${SHLINK_HOST:-shlink.${SITE:-localhost}}
      IS_HTTPS_ENABLED: false
      GEOLITE_LICENSE_KEY: ${SHLINK_GEOLITE_LICENSE_KEY:-''}
      AUTO_RESOLVE_TITLES: ${SHLINK_AUTO_RESOLVE_TITLES:-false}
      TIMEZONE: ${SHLINK_TIMEZONE:-'Europe/Madrid'}
      MULTI_SEGMENT_SLUGS_ENABLED: ${SHLINK_MULTI_SEGMENT_SLUGS_ENABLED:-false}
      SHORT_URL_TRAILING_SLASH: ${SHLINK_SHORT_URL_TRAILING_SLASH:-true}
      SHORT_URL_MODE: ${SHLINK_SHORT_URL_MODE:-strict}

      # Database
      DB_DRIVER: maria
      DB_NAME: ${SHLINK_MARIADB_DATABASE:-shlink}
      DB_USER: ${SHLINK_MARIADB_USER:-shlink}
      DB_PASSWORD: ${SHLINK_MARIADB_PASSWORD:-shlink}
      DB_HOST: shlink-db

      # Visits tracking
      DISABLE_TRACKING: ${SHLINK_DISABLE_TRACKING:-false}
      DISABLE_IP_TRACKING: ${SHLINK_DISABLE_IP_TRACKING:-false}
      SKIP_INITIAL_GEOLITE_DOWNLOAD: true
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.shlink-backend.rule=Host(`${SHLINK_HOST:-shlink.${SITE:-localhost}}`) && PathPrefix(`/`)'
      - 'traefik.http.services.shlink-backend.loadbalancer.server.port=8080'
      - 'traefik.http.middlewares.shlink-strip-admin.stripprefix.prefixes=/admin'
      - 'traefik.http.routers.shlink-backend.middlewares=shlink-strip-admin'

  shlink-web-client:
    image: shlinkio/shlink-web-client:${SHLINK_IMAGE_VERSION:-stable}
    restart: always
    container_name: shlink-gui
    networks:
      - 'srv'
    restart: always
    depends_on:
      - shlink
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.shlink-gui.rule=Host(`${SHLINK_HOST:-shlink.${SITE:-localhost}}`) && Path(`/admin`)'
      - 'traefik.http.middlewares.shlink-strip-admin.stripprefix.prefixes=/admin'
      - 'traefik.http.routers.shlink-gui.middlewares=strip-admin'
      - 'traefik.http.services.shlink-gui.loadbalancer.server.port=80'
      - 'traefik.http.middlewares.shlink-redirect-stripped-admin.redirectregex.regex=^https?://${SHLINK_HOST:-shlink.${SITE:-localhost}}/admin/(.*)'
      - "traefik.http.middlewares.shlink-redirect-stripped-admin.redirectregex.replacement=https://${SHLINK_HOST:-shlink.${SITE:-localhost}}/$${1}"
      - 'traefik.http.routers.shlink-gui.middlewares=shlink-redirect-stripped-admin@docker,shadow_auth@docker'
      - 'homepage.group=Web'
      - 'homepage.name=Shlink admin panel'
      - 'homepage.icon=shlink.png'
      - 'homepage.href=https://${SHLINK_HOST:-shlink.${SITE:-localhost}}/admin'
      - 'homepage.description=The definitive self-hosted URL shortener.'

  shlink-db:
    image: mariadb:${MARIADB_IMAGE_VERSION:-latest}
    restart: always
    container_name: shlink-db
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - 'shlink-internal'
    volumes:
      - './shlink/db:/var/lib/mysql'
    labels:
      - 'traefik.enable=false'
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
      MYSQL_USER: ${SHLINK_MARIADB_USER:-shlink}
      MYSQL_DATABASE: ${SHLINK_MARIADB_DATABASE:-shlink}
      MYSQL_PASSWORD: ${SHLINK_MARIADB_PASSWORD:-shlink}

networks:
  shlink-internal:
